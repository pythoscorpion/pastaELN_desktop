"use strict";

var _Store = _interopRequireDefault(require("./Store"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

/** React-DOM version that does not interact locally
 *  - this is the sibling of the same file in React-Electron
 *      -> that version has real local interaction
 *  - both should have the same exported functions,...
 *  - these should be the only files that differ in both; AKA they are not hard-linked
 *
 * test if this is really React-Electron
 *      if{window && window.process && window.process.type){
*/
const ELECTRON = true;

function platformSpecific(command) {
  console.log('platform', navigator.appVersion); //TODO_P2 remove as only for testing

  if (navigator.appVersion.indexOf("Linux") != -1) {
    if (command == 'pastaELN.py') return './pastaELN.py';
  } else if (navigator.appVersion.indexOf("Win") != -1) {
    if (command == 'pastaELN.py') return 'pastaELN.py';
  }

  console.log('**ERROR undefined platform', navigator.appVersion);
  return 'pastaELN.py';
}

function getCredentials() {
  /** get credentials and the entire content from json file
   */
  const fs = window.require('fs');

  const homepath = process.env.HOME ? process.env.HOME : process.env.HOMEDRIVE + process.env.HOMEPATH;
  const path = homepath + '/pastaELN.json'; // eslint-disable-line no-undef

  process.stdout.write('*********************\n');
  process.stdout.write(path + '\n');

  if (fs.existsSync(path)) {
    var config = JSON.parse(fs.readFileSync(path).toString());
    const configName = config['default'];

    if (!configName) {
      console.log('default not in configuration. Choose first.');
      configName = Object.keys(config['links'])[0];
    }

    if (!config['links'][configName]) {
      console.log('**ERROR config name not in links');
    }

    var credential = config['links'][configName]['local'];

    if (!credential) {
      console.log('default entry ' + configName + ' not in links');
      configName = Object.keys(config['links'])[0]['local'];
      credential = config['links'][configName];
    }

    if (!('path' in credential)) {
      console.log('path not in sub-configuration ' + configName);
      credential['path'] = null;
    }

    console.log('File:', path, '  ConfigName:', configName, ' Database and path on harddisk', credential['database'], credential['path']);

    if (!('url' in credential) || credential['url'] === null) {
      credential['url'] = 'http://127.0.0.1:5984';
    }

    if (credential.cred) {
      const child_process = require('child_process');

      const softwareDir = config['softwareDir'];
      var result = child_process.execSync('python3 pastaELN.py up -i ' + credential.cred, {
        cwd: softwareDir
      });
      process.stdout.write('***********result**********\n');
      process.stdout.write(result + '\n');
      result = result.toString().slice(5, -2).split(',');
      result = result.map(i => {
        return i.trim().slice(1, -1).split(':');
      });
      [credential['user'], credential['password']] = result.length == 1 ? result[0] : result;
    }

    return {
      credentials: credential,
      configuration: config
    };
  } else {
    return {
      credentials: null,
      configuration: null
    }; // error ocurred
  }
}

function getUP(aString) {
  const child_process = require('child_process');

  var softwareDir = _Store.default.getConfiguration();

  softwareDir = softwareDir['softwareDir'];
  var result = child_process.execSync('python3 pastaELN.py' + ' up -i ' + aString, {
    cwd: softwareDir
  });
  result = result.toString().slice(5, -2).split(',');
  result = result.map(i => {
    return i.trim().slice(1, -1).split(':');
  });
  return result.length == 1 ? result[0] : result;
}

function editDefault(value) {
  const fs = window.require('fs');

  const homepath = process.env.HOME ? process.env.HOME : process.env.HOMEDRIVE + process.env.HOMEPATH;
  const path = homepath + '/pastaELN.json'; // eslint-disable-line no-undef

  if (fs.existsSync(path)) {
    var config = JSON.parse(fs.readFileSync(path).toString());
    config['default'] = value;
    fs.writeFileSync(path, JSON.stringify(config, null, 2));
  }
}

function deleteConfig(name) {
  const fs = window.require('fs');

  const homepath = process.env.HOME ? process.env.HOME : process.env.HOMEDRIVE + process.env.HOMEPATH;
  const path = homepath + '/pastaELN.json'; // eslint-disable-line no-undef

  if (fs.existsSync(path)) {
    var config = JSON.parse(fs.readFileSync(path).toString());
    delete config.links[name];
    if (config['default'] == name) config['default'] = Object.keys(config.links)[0];
    fs.writeFileSync(path, JSON.stringify(config, null, 2));
  }
}

function saveCredentials(object) {
  var name = object.name;
  delete object['name'];
  if (!object.remote.user) object.remote = {};

  const fs = window.require('fs');

  const homepath = process.env.HOME ? process.env.HOME : process.env.HOMEDRIVE + process.env.HOMEPATH;
  const pathJson = homepath + '/pastaELN.json'; // eslint-disable-line no-undef

  if (fs.existsSync(pathJson)) {
    var config = JSON.parse(fs.readFileSync(pathJson).toString());
    config.links[name] = object;
    config['default'] = name;
    fs.writeFileSync(pathJson, JSON.stringify(config, null, 2));
  }
}

function saveTableFormat(docType, colWidth) {
  const fs = window.require('fs');

  const homepath = process.env.HOME ? process.env.HOME : process.env.HOMEDRIVE + process.env.HOMEPATH;
  const path = homepath + '/pastaELN.json'; // eslint-disable-line no-undef

  if (fs.existsSync(path)) {
    var config = JSON.parse(fs.readFileSync(path).toString());

    if (config['tableFormat'][docType]) {
      config['tableFormat'][docType]['-default-'] = colWidth;
    } else {
      config['tableFormat'][docType] = {
        '-default-': colWidth
      };
    }

    fs.writeFileSync(path, JSON.stringify(config, null, 2));
  }
}

function saveTableLabel(labels) {
  const fs = window.require('fs');

  const homepath = process.env.HOME ? process.env.HOME : process.env.HOMEDRIVE + process.env.HOMEPATH;
  const path = homepath + '/pastaELN.json'; // eslint-disable-line no-undef

  if (fs.existsSync(path)) {
    var config = JSON.parse(fs.readFileSync(path).toString());
    Object.keys(labels).map(docType => {
      if (docType in config['tableFormat']) config['tableFormat'][docType]['-label-'] = labels[docType];else config['tableFormat'][docType] = {
        '-label-': labels[docType]
      };
    });
    fs.writeFileSync(path, JSON.stringify(config, null, 2));
  }
}

function executeCmd(task, callback, docID = null, content = null) {
  /** execute local command using child-processes
   */
  const child_process = require('child_process');

  const taskArray = task.split('_');

  if (taskArray[2] != 'be') {
    console.log('executeCmd got no backend', task);
    return;
  } //all backend tasks:
  //- "test" = "Health check", connection to backend->database->local file storage
  //- "verifyDB" integrity, logic tests
  //- "loadBackup", "saveBackup"
  //- "sync" = replicate
  //- "scan" + docID : scan that project for new content: new measurements
  //- "saveHierarchy" + docID + content: save project structure (substeps, subtasks) to harddisk and database
  //- "createDoc" ( + docID ) + content: create a new measurement, project, procedure by interactive with harddisk and database
  //- "redo" + docID + content: redo measurement with docID and content=doc['-type'].join('/')


  if (taskArray[3] === 'saveHierarchy') {
    content = content.replace(/\n/g, '\\n');
    if (content[0] === ' ') content = content.slice(1);
  }

  if (taskArray[3] === 'createDoc') {
    if (content['docType'] === 'x0') docID = null;
    content = encodeURI(String(JSON.stringify(content)));
  } //create command


  var cmd = 'python3 pastaELN.py' + ' ' + taskArray[3];
  if (docID) cmd += ' --docID ' + docID;
  if (content) cmd += " --content '" + content + "'";

  const softwareDir = _Store.default.getConfiguration()['softwareDir'];

  child_process.exec(cmd, {
    cwd: softwareDir
  }, (error, stdout) => {
    console.log(cmd + '\n' + stdout);

    if (error) {
      callback(error.message + ' ' + task);
      throw error;
    } else {
      callback(stdout.trim() + ' ' + task);
    }
  });
}

function getHomeDir() {
  const homepath = process.env.HOME ? process.env.HOME : process.env.HOMEDRIVE + process.env.HOMEPATH;
  if (process.platform == 'win32') return homepath + '\\My Documents\\';
  return homepath + '/';
}

function testDirectory(path) {
  const fs = window.require('fs');

  if (fs.existsSync(path)) {
    return true;
  }

  return false;
}

exports.ELECTRON = ELECTRON;
exports.getCredentials = getCredentials;
exports.editDefault = editDefault;
exports.saveCredentials = saveCredentials;
exports.saveTableFormat = saveTableFormat;
exports.saveTableLabel = saveTableLabel;
exports.executeCmd = executeCmd;
exports.getHomeDir = getHomeDir;
exports.testDirectory = testDirectory;
exports.getUP = getUP;
exports.deleteConfig = deleteConfig;
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInJlbmRlcmVyL2xvY2FsSW50ZXJhY3Rpb24uanMiXSwibmFtZXMiOlsiRUxFQ1RST04iLCJwbGF0Zm9ybVNwZWNpZmljIiwiY29tbWFuZCIsImNvbnNvbGUiLCJsb2ciLCJuYXZpZ2F0b3IiLCJhcHBWZXJzaW9uIiwiaW5kZXhPZiIsImdldENyZWRlbnRpYWxzIiwiZnMiLCJ3aW5kb3ciLCJyZXF1aXJlIiwiaG9tZXBhdGgiLCJwcm9jZXNzIiwiZW52IiwiSE9NRSIsIkhPTUVEUklWRSIsIkhPTUVQQVRIIiwicGF0aCIsInN0ZG91dCIsIndyaXRlIiwiZXhpc3RzU3luYyIsImNvbmZpZyIsIkpTT04iLCJwYXJzZSIsInJlYWRGaWxlU3luYyIsInRvU3RyaW5nIiwiY29uZmlnTmFtZSIsIk9iamVjdCIsImtleXMiLCJjcmVkZW50aWFsIiwiY3JlZCIsImNoaWxkX3Byb2Nlc3MiLCJzb2Z0d2FyZURpciIsInJlc3VsdCIsImV4ZWNTeW5jIiwiY3dkIiwic2xpY2UiLCJzcGxpdCIsIm1hcCIsImkiLCJ0cmltIiwibGVuZ3RoIiwiY3JlZGVudGlhbHMiLCJjb25maWd1cmF0aW9uIiwiZ2V0VVAiLCJhU3RyaW5nIiwiU3RvcmUiLCJnZXRDb25maWd1cmF0aW9uIiwiZWRpdERlZmF1bHQiLCJ2YWx1ZSIsIndyaXRlRmlsZVN5bmMiLCJzdHJpbmdpZnkiLCJkZWxldGVDb25maWciLCJuYW1lIiwibGlua3MiLCJzYXZlQ3JlZGVudGlhbHMiLCJvYmplY3QiLCJyZW1vdGUiLCJ1c2VyIiwicGF0aEpzb24iLCJzYXZlVGFibGVGb3JtYXQiLCJkb2NUeXBlIiwiY29sV2lkdGgiLCJzYXZlVGFibGVMYWJlbCIsImxhYmVscyIsImV4ZWN1dGVDbWQiLCJ0YXNrIiwiY2FsbGJhY2siLCJkb2NJRCIsImNvbnRlbnQiLCJ0YXNrQXJyYXkiLCJyZXBsYWNlIiwiZW5jb2RlVVJJIiwiU3RyaW5nIiwiY21kIiwiZXhlYyIsImVycm9yIiwibWVzc2FnZSIsImdldEhvbWVEaXIiLCJw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QUFSLEdBQXNCQSxZQUF0QiIsInNvdXJjZXNDb250ZW50IjpbIi8qKiBSZWFjdC1ET00gdmVyc2lvbiB0aGF0IGRvZXMgbm90IGludGVyYWN0IGxvY2FsbHlcbiAqICAtIHRoaXMgaXMgdGhlIHNpYmxpbmcgb2YgdGhlIHNhbWUgZmlsZSBpbiBSZWFjdC1FbGVjdHJvblxuICogICAgICAtPiB0aGF0IHZlcnNpb24gaGFzIHJlYWwgbG9jYWwgaW50ZXJhY3Rpb25cbiAqICAtIGJvdGggc2hvdWxkIGhhdmUgdGhlIHNhbWUgZXhwb3J0ZWQgZnVuY3Rpb25zLC4uLlxuICogIC0gdGhlc2Ugc2hvdWxkIGJlIHRoZSBvbmx5IGZpbGVzIHRoYXQgZGlmZmVyIGluIGJvdGg7IEFLQSB0aGV5IGFyZSBub3QgaGFyZC1saW5rZWRcbiAqXG4gKiB0ZXN0IGlmIHRoaXMgaXMgcmVhbGx5IFJlYWN0LUVsZWN0cm9uXG4gKiAgICAgIGlme3dpbmRvdyAmJiB3aW5kb3cucHJvY2VzcyAmJiB3aW5kb3cucHJvY2Vzcy50eXBlKXtcbiovXG5pbXBvcnQgU3RvcmUgZnJvbSAnLi9TdG9yZSc7XG5jb25zdCBFTEVDVFJPTiA9IHRydWU7XG5cbmZ1bmN0aW9uIHBsYXRmb3JtU3BlY2lmaWMoY29tbWFuZCl7XG4gIGNvbnNvbGUubG9nKCdwbGF0Zm9ybScsbmF2aWdhdG9yLmFwcFZlcnNpb24pOyAvL1RPRE9fUDIgcmVtb3ZlIGFzIG9ubHkgZm9yIHRlc3RpbmdcbiAgaWYgKG5hdmlnYXRvci5hcHBWZXJzaW9uLmluZGV4T2YoXCJMaW51eFwiKSAhPSAtMSl7XG4gICAgaWYgKGNvbW1hbmQ9PSdwYXN0YUVMTi5weScpXG4gICAgICByZXR1cm4gJy4vcGFzdGFFTE4ucHknO1xuXG4gIH0gZWxzZSBpZiAobmF2aWdhdG9yLmFwcFZlcnNpb24uaW5kZXhPZihcIldpblwiKSAhPSAtMSl7XG4gICAgaWYgKGNvbW1hbmQ9PSdwYXN0YUVMTi5weScpXG4gICAgICByZXR1cm4gJ3Bhc3RhRUxOLnB5JztcblxuICB9XG4gIGNvbnNvbGUubG9nKCcqKkVSUk9SIHVuZGVmaW5lZCBwbGF0Zm9ybScsbmF2aWdhdG9yLmFwcFZlcnNpb24pXG4gIHJldHVybiAncGFzdGFFTE4ucHknO1xufVxuXG5mdW5jdGlvbiBnZXRDcmVkZW50aWFscygpe1xuICAvKiogZ2V0IGNyZWRlbnRpYWxzIGFuZCB0aGUgZW50aXJlIGNvbnRlbnQgZnJvbSBqc29uIGZpbGVcbiAgICovXG4gIGNvbnN0IGZzID0gd2luZG93LnJlcXVpcmUoJ2ZzJyk7XG4gIGNvbnN0IGhvbWVwYXRoID0gcHJvY2Vzcy5lbnYuSE9NRSA/IHByb2Nlc3MuZW52LkhPTUUgOiBwcm9jZXNzLmVudi5IT01FRFJJVkUrcHJvY2Vzcy5lbnYuSE9NRVBBVEg7XG4gIFxuICBjb25zdCBwYXRoID0gaG9tZXBhdGgrJy9wYXN0YUVMTi5qc29uJzsgICAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIG5vLXVuZGVmXG4gIFxuICBwcm9jZXNzLnN0ZG91dC53cml0ZSgnKioqKioqKioqKioqKioqKioqKioqXFxuJylcbiAgcHJvY2Vzcy5zdGRvdXQud3JpdGUocGF0aCsnXFxuJylcbiAgXG4gIGlmIChmcy5leGlzdHNTeW5jKHBhdGgpKSB7XG4gICAgdmFyIGNvbmZpZyA9IEpTT04ucGFyc2UoIGZzLnJlYWRGaWxlU3luYyhwYXRoKS50b1N0cmluZygpICk7XG4gICAgY29uc3QgY29uZmlnTmFtZSA9IGNvbmZpZ1snZGVmYXVsdCddO1xuICAgIGlmICghY29uZmlnTmFtZSkge1xuICAgICAgY29uc29sZS5sb2coJ2RlZmF1bHQgbm90IGluIGNvbmZpZ3VyYXRpb24uIENob29zZSBmaXJzdC4nKTtcbiAgICAgIGNvbmZpZ05hbWUgPSBPYmplY3Qua2V5cyhjb25maWdbJ2xpbmtzJ10pWzBdO1xuICAgIH1cbiAgICBpZiAoIWNvbmZpZ1snbGlua3MnXVtjb25maWdOYW1lXSkge1xuICAgICAgY29uc29sZS5sb2coJyoqRVJST1IgY29uZmlnIG5hbWUgbm90IGluIGxpbmtzJyk7XG4gICAgfVxuICAgIHZhciBjcmVkZW50aWFsID0gY29uZmlnWydsaW5rcyddW2NvbmZpZ05hbWVdWydsb2NhbCddO1xuICAgIGlmICghY3JlZGVudGlhbCkge1xuICAgICAgY29uc29sZS5sb2coJ2RlZmF1bHQgZW50cnkgJytjb25maWdOYW1lKycgbm90IGluIGxpbmtzJyk7XG4gICAgICBjb25maWdOYW1lID0gT2JqZWN0LmtleXMoY29uZmlnWydsaW5rcyddKVswXVsnbG9jYWwnXTtcbiAgICAgIGNyZWRlbnRpYWwgPSBjb25maWdbJ2xpbmtzJ11bY29uZmlnTmFtZV07XG4gICAgfVxuICAgIGlmICghKCgncGF0aCcpIGluIGNyZWRlbnRpYWwpKXtcbiAgICAgIGNvbnNvbGUubG9nKCdwYXRoIG5vdCBpbiBzdWItY29uZmlndXJhdGlvbiAnK2NvbmZpZ05hbWUpO1xuICAgICAgY3JlZGVudGlhbFsncGF0aCddPW51bGw7XG4gICAgfVxuICAgIGNvbnNvbGUubG9nKCdGaWxlOicscGF0aCwnICBDb25maWdOYW1lOicsY29uZmlnTmFtZSwnIERhdGFiYXNlIGFuZCBwYXRoIG9uIGhhcmRkaXNrJyxcbiAgICAgIGNyZWRlbnRpYWxbJ2RhdGFiYXNlJ10sY3JlZGVudGlhbFsncGF0aCddKTtcbiAgICBpZiAoISgndXJsJyBpbiBjcmVkZW50aWFsKSB8fCAoY3JlZGVudGlhbFsndXJsJ109PT1udWxsKSl7XG4gICAgICBjcmVkZW50aWFsWyd1cmwnXT0naHR0cDovLzEyNy4wLjAuMTo1OTg0JztcbiAgICB9XG4gICAgaWYgKGNyZWRlbnRpYWwuY3JlZCkge1xuICAgICAgY29uc3QgY2hpbGRfcHJvY2VzcyA9IHJlcXVpcmUoJ2NoaWxkX3Byb2Nlc3MnKTtcbiAgICAgIGNvbnN0IHNvZnR3YXJlRGlyID0gY29uZmlnWydzb2Z0d2FyZURpciddO1xuICAgICAgdmFyIHJlc3VsdCA9IGNoaWxkX3Byb2Nlc3MuZXhlY1N5bmMoJ3B5dGhvbjMgcGFzdGFFTE4ucHkgdXAgLWkgJytjcmVkZW50aWFsLmNyZWQsXG4gICAgICAgIHtjd2Q6c29mdHdhcmVEaXJ9KTtcbiAgICAgIFxuICAgICAgcHJvY2Vzcy5zdGRvdXQud3JpdGUoJyoqKioqKioqKioqcmVzdWx0KioqKioqKioqKlxcbicpXG4gICAgICBwcm9jZXNzLnN0ZG91dC53cml0ZShyZXN1bHQrJ1xcbicpXG4gICAgICBcbiAgICAgIHJlc3VsdCA9IHJlc3VsdC50b1N0cmluZygpLnNsaWNlKDUsLTIpLnNwbGl0KCcsJylcbiAgICAgIHJlc3VsdCA9IHJlc3VsdC5tYXAoaT0+e3JldHVybihpLnRyaW0oKS5zbGljZSgxLC0xKS5zcGxpdCgnOicpKX0pO1xuICAgICAgW2NyZWRlbnRpYWxbJ3VzZXInXSwgY3JlZGVudGlhbFsncGFzc3dvcmQnXV0gPSByZXN1bHQubGVuZ3RoPT0xID8gcmVzdWx0WzBdIDogcmVzdWx0O1xuICAgIH1cbiAgICByZXR1cm4ge2NyZWRlbnRpYWxzOmNyZWRlbnRpYWwsIGNvbmZpZ3VyYXRpb246Y29uZmlnfTtcbiAgfSBlbHNlIHtcbiAgICByZXR1cm4ge2NyZWRlbnRpYWxzOm51bGwsIGNvbmZpZ3VyYXRpb246bnVsbH07ICAvLyBlcnJvciBvY3VycmVkXG4gIH1cbn1cblxuZnVuY3Rpb24gZ2V0VVAoYVN0cmluZyl7XG4gIGNvbnN0IGNoaWxkX3Byb2Nlc3MgPSByZXF1aXJlKCdjaGlsZF9wcm9jZXNzJyk7XG4gIHZhciBzb2Z0d2FyZURpciA9IFN0b3JlLmdldENvbmZpZ3VyYXRpb24oKTtcbiAgc29mdHdhcmVEaXIgPSBzb2Z0d2FyZURpclsnc29mdHdhcmVEaXInXTtcbiAgdmFyIHJlc3VsdCA9IGNoaWxkX3Byb2Nlc3MuZXhlY1N5bmMoJ3B5dGhvbjMgcGFzdGFFTE4ucHknKycgdXAgLWkgJythU3RyaW5nLCB7Y3dkOnNvZnR3YXJlRGlyfSk7XG4gIHJlc3VsdCA9IHJlc3VsdC50b1N0cmluZygpLnNsaWNlKDUsLTIpLnNwbGl0KCcsJylcbiAgcmVzdWx0ID0gcmVzdWx0Lm1hcChpPT57cmV0dXJuKGkudHJpbSgpLnNsaWNlKDEsLTEpLnNwbGl0KCc6JykpfSk7XG4gIHJldHVybiByZXN1bHQubGVuZ3RoPT0xID8gcmVzdWx0WzBdIDogcmVzdWx0O1xufVxuXG5mdW5jdGlvbiBlZGl0RGVmYXVsdCh2YWx1ZSl7XG4gIGNvbnN0IGZzID0gd2luZG93LnJlcXVpcmUoJ2ZzJyk7XG4gIGNvbnN0IGhvbWVwYXRoID0gcHJvY2Vzcy5lbnYuSE9NRSA/IHByb2Nlc3MuZW52LkhPTUUgOiBwcm9jZXNzLmVudi5IT01FRFJJVkUrcHJvY2Vzcy5lbnYuSE9NRVBBVEg7XG4gIGNvbnN0IHBhdGggPSBob21lcGF0aCsnL3Bhc3RhRUxOLmpzb24nOyAgIC8vIGVzbGludC1kaXNhYmxlLWxpbmUgbm8tdW5kZWZcbiAgaWYgKGZzLmV4aXN0c1N5bmMocGF0aCkpIHtcbiAgICB2YXIgY29uZmlnID0gSlNPTi5wYXJzZSggZnMucmVhZEZpbGVTeW5jKHBhdGgpLnRvU3RyaW5nKCkgKTtcbiAgICBjb25maWdbJ2RlZmF1bHQnXSA9IHZhbHVlO1xuICAgIGZzLndyaXRlRmlsZVN5bmMocGF0aCwgIEpTT04uc3RyaW5naWZ5KGNvbmZpZyxudWxsLDIpICk7XG4gIH1cbn1cblxuZnVuY3Rpb24gZGVsZXRlQ29uZmlnKG5hbWUpe1xuICBjb25zdCBmcyA9IHdpbmRvdy5yZXF1aXJlKCdmcycpO1xuICBjb25zdCBob21lcGF0aCA9IHByb2Nlc3MuZW52LkhPTUUgPyBwcm9jZXNzLmVudi5IT01FIDogcHJvY2Vzcy5lbnYuSE9NRURSSVZFK3Byb2Nlc3MuZW52LkhPTUVQQVRIO1xuICBjb25zdCBwYXRoID0gaG9tZXBhdGgrJy9wYXN0YUVMTi5qc29uJzsgICAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIG5vLXVuZGVmXG4gIGlmIChmcy5leGlzdHNTeW5jKHBhdGgpKSB7XG4gICAgdmFyIGNvbmZpZyA9IEpTT04ucGFyc2UoIGZzLnJlYWRGaWxlU3luYyhwYXRoKS50b1N0cmluZygpICk7XG4gICAgZGVsZXRlIGNvbmZpZy5saW5rc1tuYW1lXTtcbiAgICBpZiAoY29uZmlnWydkZWZhdWx0J109PW5hbWUpXG4gICAgICBjb25maWdbJ2RlZmF1bHQnXT1PYmplY3Qua2V5cyhjb25maWcubGlua3MpWzBdO1xuICAgIGZzLndyaXRlRmlsZVN5bmMocGF0aCwgIEpTT04uc3RyaW5naWZ5KGNvbmZpZyxudWxsLDIpICk7XG4gIH1cblxufVxuXG5mdW5jdGlvbiBzYXZlQ3JlZGVudGlhbHMob2JqZWN0KXtcbiAgdmFyIG5hbWUgPSBvYmplY3QubmFtZTtcbiAgZGVsZXRlIG9iamVjdFsnbmFtZSddO1xuICBpZiAoIW9iamVjdC5yZW1vdGUudXNlcilcbiAgICBvYmplY3QucmVtb3RlID0ge307XG4gIGNvbnN0IGZzID0gd2luZG93LnJlcXVpcmUoJ2ZzJyk7XG4gIGNvbnN0IGhvbWVwYXRoID0gcHJvY2Vzcy5lbnYuSE9NRSA/IHByb2Nlc3MuZW52LkhPTUUgOiBwcm9jZXNzLmVudi5IT01FRFJJVkUrcHJvY2Vzcy5lbnYuSE9NRVBBVEg7XG4gIGNvbnN0IHBhdGhKc29uID0gaG9tZXBhdGgrJy9wYXN0YUVMTi5qc29uJzsgICAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIG5vLXVuZGVmXG4gIGlmIChmcy5leGlzdHNTeW5jKHBhdGhKc29uKSkge1xuICAgIHZhciBjb25maWcgPSBKU09OLnBhcnNlKCBmcy5yZWFkRmlsZVN5bmMocGF0aEpzb24pLnRvU3RyaW5nKCkgKTtcbiAgICBjb25maWcubGlua3NbbmFtZV0gPSBvYmplY3Q7XG4gICAgY29uZmlnWydkZWZhdWx0J10gPSBuYW1lO1xuICAgIGZzLndyaXRlRmlsZVN5bmMocGF0aEpzb24sICBKU09OLnN0cmluZ2lmeShjb25maWcsbnVsbCwyKSApO1xuICB9XG59XG5cbmZ1bmN0aW9uIHNhdmVUYWJsZUZvcm1hdChkb2NUeXBlLGNvbFdpZHRoKXtcbiAgY29uc3QgZnMgPSB3aW5kb3cucmVxdWlyZSgnZnMnKTtcbiAgY29uc3QgaG9tZXBhdGggPSBwcm9jZXNzLmVudi5IT01FID8gcHJvY2Vzcy5lbnYuSE9NRSA6IHByb2Nlc3MuZW52LkhPTUVEUklWRStwcm9jZXNzLmVudi5IT01FUEFUSDtcbiAgY29uc3QgcGF0aCA9IGhvbWVwYXRoKycvcGFzdGFFTE4uanNvbic7ICAgLy8gZXNsaW50LWRpc2FibGUtbGluZSBuby11bmRlZlxuICBpZiAoZnMuZXhpc3RzU3luYyhwYXRoKSkge1xuICAgIHZhciBjb25maWcgPSBKU09OLnBhcnNlKCBmcy5yZWFkRmlsZVN5bmMocGF0aCkudG9TdHJpbmcoKSApO1xuICAgIGlmIChjb25maWdbJ3RhYmxlRm9ybWF0J11bZG9jVHlwZV0pIHtcbiAgICAgIGNvbmZpZ1sndGFibGVGb3JtYXQnXVtkb2NUeXBlXVsnLWRlZmF1bHQtJ10gPSBjb2xXaWR0aDtcbiAgICB9IGVsc2Uge1xuICAgICAgY29uZmlnWyd0YWJsZUZvcm1hdCddW2RvY1R5cGVdID0geyctZGVmYXVsdC0nOmNvbFdpZHRofTtcbiAgICB9XG4gICAgZnMud3JpdGVGaWxlU3luYyhwYXRoLCAgSlNPTi5zdHJpbmdpZnkoY29uZmlnLG51bGwsMikgKTtcbiAgfVxufVxuXG5mdW5jdGlvbiBzYXZlVGFibGVMYWJlbChsYWJlbHMpe1xuICBjb25zdCBmcyA9IHdpbmRvdy5yZXF1aXJlKCdmcycpO1xuICBjb25zdCBob21lcGF0aCA9IHByb2Nlc3MuZW52LkhPTUUgPyBwcm9jZXNzLmVudi5IT01FIDogcHJvY2Vzcy5lbnYuSE9NRURSSVZFK3Byb2Nlc3MuZW52LkhPTUVQQVRIO1xuICBjb25zdCBwYXRoID0gaG9tZXBhdGgrJy9wYXN0YUVMTi5qc29uJzsgICAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIG5vLXVuZGVmXG4gIGlmIChmcy5leGlzdHNTeW5jKHBhdGgpKSB7XG4gICAgdmFyIGNvbmZpZyA9IEpTT04ucGFyc2UoIGZzLnJlYWRGaWxlU3luYyhwYXRoKS50b1N0cmluZygpICk7XG4gICAgT2JqZWN0LmtleXMobGFiZWxzKS5tYXAoZG9jVHlwZT0+e1xuICAgICAgaWYgKGRvY1R5cGUgaW4gY29uZmlnWyd0YWJsZUZvcm1hdCddKVxuICAgICAgICBjb25maWdbJ3RhYmxlRm9ybWF0J11bZG9jVHlwZV1bJy1sYWJlbC0nXSA9IGxhYmVsc1tkb2NUeXBlXTtcbiAgICAgIGVsc2VcbiAgICAgICAgY29uZmlnWyd0YWJsZUZvcm1hdCddW2RvY1R5cGVdID0geyctbGFiZWwtJzpsYWJlbHNbZG9jVHlwZV19O1xuICAgIH0pO1xuICAgIGZzLndyaXRlRmlsZVN5bmMocGF0aCwgIEpTT04uc3RyaW5naWZ5KGNvbmZpZyxudWxsLDIpICk7XG4gIH1cbn1cblxuZnVuY3Rpb24gZXhlY3V0ZUNtZCh0YXNrLGNhbGxiYWNrLGRvY0lEPW51bGwsY29udGVudD1udWxsKSB7XG4gIC8qKiBleGVjdXRlIGxvY2FsIGNvbW1hbmQgdXNpbmcgY2hpbGQtcHJvY2Vzc2VzXG4gICAqL1xuICBjb25zdCBjaGlsZF9wcm9jZXNzID0gcmVxdWlyZSgnY2hpbGRfcHJvY2VzcycpO1xuICBjb25zdCB0YXNrQXJyYXkgPSB0YXNrLnNwbGl0KCdfJyk7XG4gIGlmICh0YXNrQXJyYXlbMl0hPSdiZScpIHtcbiAgICBjb25zb2xlLmxvZygnZXhlY3V0ZUNtZCBnb3Qgbm8gYmFja2VuZCcsdGFzayk7XG4gICAgcmV0dXJuO1xuICB9XG4gIC8vYWxsIGJhY2tlbmQgdGFza3M6XG4gIC8vLSBcInRlc3RcIiA9IFwiSGVhbHRoIGNoZWNrXCIsIGNvbm5lY3Rpb24gdG8gYmFja2VuZC0+ZGF0YWJhc2UtPmxvY2FsIGZpbGUgc3RvcmFnZVxuICAvLy0gXCJ2ZXJpZnlEQlwiIGludGVncml0eSwgbG9naWMgdGVzdHNcbiAgLy8tIFwibG9hZEJhY2t1cFwiLCBcInNhdmVCYWNrdXBcIlxuICAvLy0gXCJzeW5jXCIgPSByZXBsaWNhdGVcbiAgLy8tIFwic2NhblwiICsgZG9jSUQgOiBzY2FuIHRoYXQgcHJvamVjdCBmb3IgbmV3IGNvbnRlbnQ6IG5ldyBtZWFzdXJlbWVudHNcbiAgLy8tIFwic2F2ZUhpZXJhcmNoeVwiICsgZG9jSUQgKyBjb250ZW50OiBzYXZlIHByb2plY3Qgc3RydWN0dXJlIChzdWJzdGVwcywgc3VidGFza3MpIHRvIGhhcmRkaXNrIGFuZCBkYXRhYmFzZVxuICAvLy0gXCJjcmVhdGVEb2NcIiAoICsgZG9jSUQgKSArIGNvbnRlbnQ6IGNyZWF0ZSBhIG5ldyBtZWFzdXJlbWVudCwgcHJvamVjdCwgcHJvY2VkdXJlIGJ5IGludGVyYWN0aXZlIHdpdGggaGFyZGRpc2sgYW5kIGRhdGFiYXNlXG4gIC8vLSBcInJlZG9cIiArIGRvY0lEICsgY29udGVudDogcmVkbyBtZWFzdXJlbWVudCB3aXRoIGRvY0lEIGFuZCBjb250ZW50PWRvY1snLXR5cGUnXS5qb2luKCcvJylcbiAgaWYgKHRhc2tBcnJheVszXT09PSdzYXZlSGllcmFyY2h5Jyl7XG4gICAgY29udGVudCA9IGNvbnRlbnQucmVwbGFjZSgvXFxuL2csJ1xcXFxuJyk7XG4gICAgaWYgKGNvbnRlbnRbMF09PT0nICcpXG4gICAgICBjb250ZW50PWNvbnRlbnQuc2xpY2UoMSk7XG4gIH1cbiAgaWYgKHRhc2tBcnJheVszXT09PSdjcmVhdGVEb2MnKSB7XG4gICAgaWYgKGNvbnRlbnRbJ2RvY1R5cGUnXT09PSd4MCcpXG4gICAgICBkb2NJRCA9IG51bGw7XG4gICAgY29udGVudCA9IGVuY29kZVVSSShTdHJpbmcoSlNPTi5zdHJpbmdpZnkoY29udGVudCkpKTtcbiAgfVxuICAvL2NyZWF0ZSBjb21tYW5kXG4gIHZhciBjbWQgPSAncHl0aG9uMyBwYXN0YUVMTi5weScrJyAnK3Rhc2tBcnJheVszXTtcbiAgaWYgKGRvY0lEKVxuICAgIGNtZCArPSAgJyAtLWRvY0lEICcrZG9jSUQ7XG4gIGlmIChjb250ZW50KVxuICAgIGNtZCArPSBcIiAtLWNvbnRlbnQgJ1wiK2NvbnRlbnQrXCInXCI7XG4gIGNvbnN0IHNvZnR3YXJlRGlyID0gU3RvcmUuZ2V0Q29uZmlndXJhdGlvbigpWydzb2Z0d2FyZURpciddO1xuICBjaGlsZF9wcm9jZXNzLmV4ZWMoY21kLCB7Y3dkOnNvZnR3YXJlRGlyfSAsIChlcnJvciwgc3Rkb3V0KSA9PiB7XG4gICAgY29uc29sZS5sb2coY21kKydcXG4nK3N0ZG91dCk7XG4gICAgaWYgKGVycm9yKSB7XG4gICAgICBjYWxsYmFjayhlcnJvci5tZXNzYWdlKycgJyt0YXNrKTtcbiAgICAgIHRocm93KGVycm9yKTtcbiAgICB9IGVsc2Uge1xuICAgICAgY2FsbGJhY2soc3Rkb3V0LnRyaW0oKSsnICcrdGFzayk7XG4gICAgfVxuICB9KTtcbn1cblxuZnVuY3Rpb24gZ2V0SG9tZURpcigpIHtcbiAgY29uc3QgaG9tZXBhdGggPSBwcm9jZXNzLmVudi5IT01FID8gcHJvY2Vzcy5lbnYuSE9NRSA6IHByb2Nlc3MuZW52LkhPTUVEUklWRStwcm9jZXNzLmVudi5IT01FUEFUSDtcbiAgaWYgKHByb2Nlc3MucGxhdGZvcm09PSd3aW4zMicpXG4gICAgcmV0dXJuIGhvbWVwYXRoKydcXFxcTXkgRG9jdW1lbnRzXFxcXCc7XG4gIHJldHVybiBob21lcGF0aCsnLyc7XG59XG5cbmZ1bmN0aW9uIHRlc3REaXJlY3RvcnkocGF0aCl7XG4gIGNvbnN0IGZzID0gd2luZG93LnJlcXVpcmUoJ2ZzJyk7XG4gIGlmIChmcy5leGlzdHNTeW5jKHBhdGgpKSB7XG4gICAgcmV0dXJuIHRydWU7XG4gIH1cbiAgcmV0dXJuIGZhbHNlO1xufVxuXG5leHBvcnRzLkVMRUNUUk9OID0gRUxFQ1RST047XG5leHBvcnRzLmdldENyZWRlbnRpYWxzID0gZ2V0Q3JlZGVudGlhbHM7XG5leHBvcnRzLmVkaXREZWZhdWx0ID0gZWRpdERlZmF1bHQ7XG5leHBvcnRzLnNhdmVDcmVkZW50aWFscyA9IHNhdmVDcmVkZW50aWFscztcbmV4cG9ydHMuc2F2ZVRhYmxlRm9ybWF0ID0gc2F2ZVRhYmxlRm9ybWF0O1xuZXhwb3J0cy5zYXZlVGFibGVMYWJlbCA9IHNhdmVUYWJsZUxhYmVsO1xuZXhwb3J0cy5leGVjdXRlQ21kID0gZXhlY3V0ZUNtZDtcbmV4cG9ydHMuZ2V0SG9tZURpciA9IGdldEhvbWVEaXI7XG5leHBvcnRzLnRlc3REaXJlY3RvcnkgPSB0ZXN0RGlyZWN0b3J5O1xuZXhwb3J0cy5nZXRVUCA9IGdldFVQO1xuZXhwb3J0cy5kZWxldGVDb25maWc9IGRlbGV0ZUNvbmZpZztcbiJdLCJmaWxlIjoicmVuZGVyZXIvbG9jYWxJbnRlcmFjdGlvbi5qcyJ9
